<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Tracker with Events</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .nav-tab {
            padding: 15px 30px;
            background: white;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .nav-tab:hover {
            background: #f0f0f0;
        }

        .nav-tab.active {
            background: #333;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        h1 {
            margin-top: 0;
        }

        h2 {
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }

        h3 {
            margin-top: 0;
        }

        input,
        select,
        button,
        textarea {
            padding: 10px;
            font-size: 16px;
            margin: 5px 0;
        }

        button {
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        button:hover {
            background: #555;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background: #333;
            color: white;
        }

        .status-in {
            background: #d4edda;
        }

        .status-out {
            background: #fff3cd;
        }

        .event-planning {
            background: #cce5ff;
        }

        .event-active {
            background: #fff3cd;
        }

        .event-completed {
            background: #d4edda;
        }

        #scanner-container {
            width: 100%;
            max-width: 500px;
            margin-top: 10px;
        }

        .qr-code {
            margin: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            display: inline-block;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .message-success {
            background: #d4edda;
            color: #155724;
        }

        .message-error {
            background: #f8d7da;
            color: #721c24;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            text-align: center;
            border-radius: 5px;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
        }

        .event-card {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .event-card:hover {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .event-meta {
            color: #666;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-planning {
            background: #cce5ff;
            color: #004085;
        }

        .badge-active {
            background: #fff3cd;
            color: #856404;
        }

        .badge-completed {
            background: #d4edda;
            color: #155724;
        }

        .checklist-item {
            padding: 15px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            background: white;
        }

        .checklist-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Not started - grey border */
        .checklist-item.not-started {
            border-left: 5px solid #6c757d;
            background: #f8f9fa;
        }

        /* Checked out - orange/yellow */
        .checklist-item.checked-out {
            border-left: 5px solid #ffc107;
            background: #fff3cd;
        }

        /* Fully returned - green */
        .checklist-item.completed {
            border-left: 5px solid #28a745;
            background: #d4edda;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.not-started {
            background: #e9ecef;
            color: #495057;
        }

        .status-badge.checked-out {
            background: #ffc107;
            color: #000;
        }

        .status-badge.completed {
            background: #28a745;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 5px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            box-sizing: border-box;
        }

        .equipment-select-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }

        .equipment-select-item {
            padding: 8px;
            margin: 5px 0;
            background: #f9f9f9;
            border: 1px solid #ddd;
            cursor: pointer;
            border-radius: 3px;
        }

        .equipment-select-item:hover {
            background: #e9e9e9;
        }

        .equipment-select-item.selected {
            background: #d4edda;
            border-color: #28a745;
        }

        /* Photo Support Styles - ADD THESE */
        .equipment-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid #ddd;
        }

        .equipment-photo:hover {
            border-color: #333;
        }

        .no-photo {
            width: 60px;
            height: 60px;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        .no-photo:hover {
            background: #d0d0d0;
        }

        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .modal-photo {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content-photo {
            position: relative;
            margin: 5% auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            background: white;
            border-radius: 5px;
        }

        .modal-image {
            width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 15px;
            background: #5cb85c;
            color: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 16px;
        }

        .file-input-label:hover {
            background: #4cae4c;
        }

        .status-partial {
            background: #fff3cd;
        }

        .quantity-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            background: #e9ecef;
            color: #495057;
        }

        .quantity-badge.full {
            background: #d4edda;
            color: #155724;
        }

        .quantity-badge.out {
            background: #f8d7da;
            color: #721c24;
        }

        .quantity-badge.partial {
            background: #fff3cd;
            color: #856404;
        }

        .category-item {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .category-description {
            color: #666;
            font-size: 14px;
        }

        .category-color-box {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            margin-right: 15px;
            border: 2px solid #ddd;
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .category-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .filter-section {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-section select {
            flex: 1;
            max-width: 300px;
        }

        #single-qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .single-qr-item {
            padding: 20px;
            background: white;
            border: 2px solid #333;
            border-radius: 5px;
            display: inline-block;
        }

        .single-qr-item canvas {
            display: block;
        }

        .single-qr-label {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            font-size: 16px;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #single-qr-container,
            #single-qr-container * {
                visibility: visible;
            }

            #single-qr-container {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
            }
        }
    </style>
</head>

<body>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Equipment Tracker with Events</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="user-info" style="color: #666;">Loading...</span>
            <button onclick="handleLogout()" style="background: #dc3545;">Logout</button>
        </div>
    </div>

    <!-- NAVIGATION TABS -->
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="showTab('equipment', this)">Equipment</div>
        <div class="nav-tab" onclick="showTab('events', this)">Events</div>
        <div class="nav-tab" onclick="showTab('templates', this)">Templates</div>
        <div class="nav-tab" onclick="showTab('categories', this)">Categories</div>
        <div class="nav-tab" onclick="showTab('users', this)">Users</div>
        <div class="nav-tab" onclick="showTab('scan', this)">Scanner</div>
    </div>

    <!-- EQUIPMENT TAB -->
    <div id="equipment-tab" class="tab-content active">
        <!-- STATS -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total Equipment</div>
                <div class="stat-number" id="stat-total">0</div>
            </div>
            <div class="stat-card status-in">
                <div class="stat-label">In Warehouse</div>
                <div class="stat-number" id="stat-in">0</div>
            </div>
            <div class="stat-card status-out">
                <div class="stat-label">Out at Events</div>
                <div class="stat-number" id="stat-out">0</div>
            </div>
        </div>

        <!-- ADD NEW EQUIPMENT -->
        <div class="section">
            <h2>Add New Equipment</h2>
            <form id="add-equipment-form" onsubmit="addEquipmentWithCategory(event); return false;">
                <div>
                    <input type="text" id="new-equipment-name" placeholder="Equipment name (e.g., XLR Cable)"
                        style="width: 400px;" required>
                </div>
                <div style="margin-top: 10px;">
                    <label for="new-equipment-quantity">Quantity:</label>
                    <input type="number" id="new-equipment-quantity" value="1" min="1" style="width: 100px;"
                        placeholder="1">
                    <small style="color: #666; margin-left: 10px;">How many of this item do you have?</small>
                </div>
                <div style="margin-top: 10px;">
                    <label for="new-equipment-category">Category:</label>
                    <select id="new-equipment-category" style="width: 300px;">
                        <option value="">No Category</option>
                    </select>
                </div>
                <div style="margin-top: 10px;">
                    <div class="file-input-wrapper">
                        <input type="file" id="equipment-photo" accept="image/*" onchange="previewPhoto(event)">
                        <label for="equipment-photo" class="file-input-label"> Choose Photo (Optional)</label>
                    </div>
                    <span id="photo-filename" style="margin-left: 10px; color: #666;"></span>
                </div>
                <div id="photo-preview-container" class="hidden">
                    <img id="photo-preview" class="photo-preview">
                    <button type="button" onclick="clearPhotoPreview()" class="danger"
                        style="display: block; margin-top: 5px;">Remove Photo</button>
                </div>
                <button type="submit" style="margin-top: 10px;">Add Equipment</button>
            </form>
        </div>

        <!-- BULK IMPORT -->
        <div class="section">
            <h2>Bulk Add Equipment</h2>
            <p>Enter multiple equipment names, one per line:</p>
            <textarea id="bulk-equipment" rows="5" style="width: 100%; padding: 10px; font-size: 16px;"
                placeholder="Projector-01&#10;Speaker-A&#10;Laptop-03&#10;..."></textarea>
            <button onclick="bulkAddEquipment()">Add All</button>
        </div>

        <!-- BACKUP/RESTORE -->
        <div class="section">
            <h2>Backup & Restore</h2>
            <button onclick="exportData()">Download Backup (JSON)</button>
            <button onclick="exportCSV()">Download as CSV</button>
            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData()">
            <button onclick="document.getElementById('import-file').click()">Restore from Backup</button>
        </div>

        <!-- GENERATE QR CODES -->
        <div class="section">
            <h2>Generate Barcodes</h2>
            <button onclick="generateAllQRCodes()">Generate Barcodes for All Equipment</button>
            <button onclick="window.print()" id="print-btn" class="hidden">Print Barcodes</button>
            <div id="qr-codes-container"></div>
        </div>

        <!-- EQUIPMENT LIST -->
        <div class="section">
            <h2>All Equipment</h2>
            <div style="margin-bottom: 10px;">
                <input type="text" id="search-box" placeholder="Search equipment..." style="width: 300px;"
                    onkeyup="filterEquipment()">
                <select id="filter-status" onchange="filterEquipment()" style="width: 150px;">
                    <option value="ALL">All Status</option>
                    <option value="IN">In Warehouse</option>
                    <option value="OUT">Out at Event</option>
                </select>
                <select id="filter-category" onchange="filterEquipment()" style="width: 200px;">
                    <option value="ALL">All Categories</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Location</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="equipment-list"></tbody>
            </table>
        </div>
    </div>

    <!-- EVENTS TAB -->
    <div id="events-tab" class="tab-content">
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Events Management</h2>
                <button class="success" onclick="showCreateEventModal()">+ Create New Event</button>
            </div>

            <div style="margin: 20px 0;">
                <select id="event-filter-status" onchange="filterEvents()" style="width: 200px;">
                    <option value="ALL">All Events</option>
                    <option value="PLANNING">Planning</option>
                    <option value="ACTIVE">Active</option>
                    <option value="COMPLETED">Completed</option>
                </select>
            </div>

            <div id="events-list"></div>
        </div>
    </div>

    <!-- TEMPLATES TAB -->
    <div id="templates-tab" class="tab-content">
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2>Equipment Templates</h2>
                    <p style="color: #666; margin-top: 5px;">Create reusable equipment lists for different event types
                    </p>
                </div>
                <button class="success" onclick="showCreateTemplateModal()">+ Create Template</button>
            </div>

            <div id="templates-list" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- SCAN TAB -->

    <!-- CATEGORIES TAB -->
    <div id="categories-tab" class="tab-content">
        <h1>Manage Categories</h1>

        <!-- ADD NEW CATEGORY -->
        <div class="section">
            <h3>Add New Category</h3>
            <input type="text" id="new-category-name" placeholder="Category Name (e.g., Audio, Video, Lighting)">
            <input type="text" id="new-category-description" placeholder="Description (optional)">
            <label>Color: <input type="color" id="new-category-color" value="#333333"></label>
            <button onclick="addCategory()">Add Category</button>
        </div>

        <!-- CATEGORIES LIST -->
        <div class="section">
            <h3>Existing Categories</h3>
            <div id="categories-list">
                <p>Loading categories...</p>
            </div>
        </div>
    </div>

    <!-- USERS TAB -->
    <div id="users-tab" class="tab-content">
        <h1>User Management</h1>

        <!-- CHANGE PASSWORD -->
        <div class="section">
            <h3>Change Your Password</h3>
            <div style="max-width: 500px;">
                <input type="password" id="new-password" placeholder="New Password (min 4 characters)">
                <input type="password" id="confirm-password" placeholder="Confirm New Password">
                <button onclick="changePassword()">Change Password</button>
            </div>
        </div>

        <!-- ADD NEW USER -->
        <div class="section">
            <h3>Add New User</h3>
            <div style="max-width: 600px;">
                <input type="text" id="new-user-username" placeholder="Username" style="width: 200px;">
                <input type="password" id="new-user-password" placeholder="Password (min 4 characters)"
                    style="width: 200px;">
                <input type="text" id="new-user-fullname" placeholder="Full Name (optional)" style="width: 250px;">
                <select id="new-user-role" style="width: 150px;">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
                <button onclick="createUser()">Add User</button>
            </div>
        </div>

        <!-- USERS LIST -->
        <div class="section">
            <h3>All Users</h3>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Full Name</th>
                        <th>Role</th>
                        <th>Created</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-list"></tbody>
            </table>
        </div>
    </div>

    <div id="scan-tab" class="tab-content">
        <h1>Scanner</h1>

        <!-- STEP 1: SELECT EVENT -->
        <div class="section">
            <h2>Step 1: Select Event</h2>
            <p style="color: #666; margin-bottom: 15px;">Choose which event you're working with, or check equipment
                in/out manually</p>

            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <select id="scan-event-select" style="width: 400px; font-size: 16px; padding: 12px;">
                    <option value="">üì¶ No Event (Manual Check In/Out)</option>
                </select>
                <button onclick="quickCreateEvent()" style="background: #28a745;">
                    ‚ûï Create New Event
                </button>
                <button onclick="refreshEventsList()" style="background: #17a2b8;">
                    üîÑ Refresh Events
                </button>
            </div>

            <!-- Active Event Display -->
            <div id="active-event-display"
                style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 5px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="font-size: 18px; color: #0056b3;">üìç Active Event:</strong>
                        <span id="active-event-name" style="font-size: 18px; margin-left: 10px;"></span>
                        <div style="margin-top: 5px; color: #666; font-size: 14px;">
                            <span id="active-event-details"></span>
                        </div>
                    </div>
                    <button onclick="clearActiveEvent()" style="background: #6c757d; font-size: 14px;">
                        Clear Event
                    </button>
                </div>
            </div>

            <!-- Manual Mode Display -->
            <div id="manual-mode-display"
                style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
                <strong style="color: #856404;">üì¶ Manual Mode:</strong>
                <span style="color: #856404; margin-left: 10px;">Scanning without an event. Equipment will check in/out
                    manually.</span>
            </div>
        </div>

        <!-- STEP 2: SCAN EQUIPMENT -->
        <div class="section">
            <h2>Step 2: Scan Equipment</h2>

            <div class="form-group">
                <label>Your Name*</label>
                <input type="text" id="scanner-user-name" placeholder="Enter your name" style="width: 300px;">
                <small style="color: #666; display: block; margin-top: 5px;">
                    This will be logged with each scan for tracking purposes
                </small>
            </div>

            <!-- Manual/Barcode Scanner Input -->
            <div style="margin-top: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Scan Equipment Barcode:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="manual-code" placeholder="Scan or type equipment code here" autofocus
                        style="width: 400px; font-size: 18px; padding: 12px;">
                    <button onclick="processManualScan()" style="font-size: 16px; padding: 12px 24px;">
                        ‚úì Submit
                    </button>
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Click in the box above, then scan with your barcode scanner, or use camera below
                </small>
            </div>

            <!-- Camera Scanner -->
            <div style="margin-top: 30px;">
                <button onclick="startCameraScanner()" style="font-size: 16px; padding: 12px 24px;">
                    üì∑ Use Camera Scanner
                </button>
                <button onclick="stopCameraScanner()" class="hidden" id="stop-camera-btn"
                    style="background: #dc3545; font-size: 16px; padding: 12px 24px;">
                    ‚õî Stop Camera
                </button>
            </div>
            <div id="scanner-container" class="hidden" style="margin-top: 20px;"></div>

            <div id="scan-result" class="hidden" style="margin-top: 20px;"></div>
        </div>

        <!-- STEP 3: RECENT ACTIVITY -->
        <div class="section">
            <h2>Recent Scan Activity</h2>
            <div id="recent-activity"></div>
        </div>
    </div>

    <!-- QUICK CREATE EVENT MODAL -->
    <div id="quick-event-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeQuickEventModal()">&times;</span>
            <h2>Quick Create Event</h2>

            <form id="quick-event-form" onsubmit="submitQuickEvent(event); return false;">
                <div class="form-group">
                    <label>Event Name*</label>
                    <input type="text" id="quick-event-name" required placeholder="e.g., Wedding - Smith Family">
                </div>

                <div class="form-group">
                    <label>Event Type*</label>
                    <select id="quick-event-type" required>
                        <option value="">Select Type</option>
                        <option value="Corporate Conference">Corporate Conference</option>
                        <option value="Wedding">Wedding</option>
                        <option value="Concert">Concert</option>
                        <option value="Sports Event">Sports Event</option>
                        <option value="Trade Show">Trade Show</option>
                        <option value="Festival">Festival</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="quick-event-date">
                </div>

                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="quick-event-location" placeholder="Event venue or address">
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" style="background: #28a745;">Create & Select Event</button>
                    <button type="button" onclick="closeQuickEventModal()" style="background: #6c757d;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CREATE/EDIT EVENT MODAL -->
    <!-- EDIT EQUIPMENT MODAL -->
    <div id="edit-equipment-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditEquipmentModal()">&times;</span>
            <h2>Edit Equipment</h2>

            <form id="edit-equipment-form" onsubmit="saveEquipmentChanges(event); return false;">
                <div class="form-group">
                    <label>Equipment Name*</label>
                    <input type="text" id="edit-equipment-name" required>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="edit-equipment-category">
                        <option value="">No Category</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quantity*</label>
                    <input type="number" id="edit-equipment-quantity" min="1" required>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Total number of this item in inventory
                    </small>
                </div>

                <div class="form-group">
                    <label>Current Status</label>
                    <input type="text" id="edit-equipment-status" disabled style="background: #f0f0f0;">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Status is automatically managed by check-ins/check-outs
                    </small>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" style="background: #28a745;">Save Changes</button>
                    <button type="button" onclick="closeEditEquipmentModal()"
                        style="background: #6c757d;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- QR CODE MODAL -->
    <div id="qrcode-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close" onclick="closeQRCodeModal()">&times;</span>
            <h2 id="qrcode-equipment-name">QR Code</h2>

            <div id="single-qr-container" style="margin: 30px 0;">
                <!-- QR code will be inserted here -->
            </div>

            <div style="margin-top: 20px;">
                <button onclick="printSingleQRCode()" style="background: #007bff;">
                    üñ®Ô∏è Print This QR Code
                </button>
                <button onclick="closeQRCodeModal()" style="background: #6c757d;">
                    Close
                </button>
            </div>

            <p style="color: #666; font-size: 14px; margin-top: 20px;">
                Scan this code to check equipment in/out
            </p>
        </div>
    </div>

    <div id="event-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEventModal()">&times;</span>
            <h2 id="event-modal-title">Create New Event</h2>

            <form id="event-form" onsubmit="return false;">
                <div class="form-group">
                    <label>Event Name*</label>
                    <input type="text" id="event-name" required>
                </div>

                <div class="form-group">
                    <label>Event Type*</label>
                    <select id="event-type" required>
                        <option value="">Select Type</option>
                        <option value="Corporate Conference">Corporate Conference</option>
                        <option value="Wedding">Wedding</option>
                        <option value="Concert">Concert</option>
                        <option value="Sports Event">Sports Event</option>
                        <option value="Trade Show">Trade Show</option>
                        <option value="Festival">Festival</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Equipment Template (Optional)</label>
                    <select id="event-template" style="margin-bottom: 5px;">
                        <option value="">None - I'll add equipment manually</option>
                    </select>
                    <small style="color: #666; display: block;">
                        Select a template to automatically add equipment to your checklist
                    </small>
                    <small id="no-templates-hint"
                        style="color: #2196F3; display: none; margin-top: 5px; cursor: pointer;"
                        onclick="goToTemplatesTab()">
                        ‚Üí No templates yet? Click here to create one
                    </small>
                </div>

                <div class="form-group">
                    <label>Event Date*</label>
                    <input type="date" id="event-date" required>
                </div>

                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="event-location" placeholder="Event venue or address">
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="event-notes" rows="3" placeholder="Additional notes about the event"></textarea>
                </div>

                <button type="button" onclick="saveEvent()" class="success">Save Event</button>
                <button type="button" onclick="closeEventModal()" class="secondary">Cancel</button>
            </form>
        </div>
    </div>

    <!-- EVENT DETAILS MODAL -->
    <div id="event-details-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEventDetailsModal()">&times;</span>
            <div id="event-details-content"></div>
        </div>
    </div>

    <!-- ADD EQUIPMENT TO EVENT MODAL -->
    <div id="add-equipment-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddEquipmentModal()">&times;</span>
            <h2>Add Equipment to Event</h2>

            <input type="text" id="equipment-search" placeholder="Search equipment..."
                style="width: 100%; margin-bottom: 10px;" onkeyup="searchEquipmentForEvent()">

            <div class="equipment-select-list" id="equipment-select-list"></div>

            <div style="margin-top: 15px;">
                <button onclick="addSelectedEquipmentToEvent()" class="success">Add Selected Equipment</button>
                <button onclick="closeAddEquipmentModal()" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- CREATE TEMPLATE MODAL -->
    <div id="template-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTemplateModal()">&times;</span>
            <h2>Create Equipment Template</h2>

            <form id="template-form" onsubmit="return false;">
                <div class="form-group">
                    <label>Template Name*</label>
                    <input type="text" id="template-name" required
                        placeholder="e.g., Wedding Package, Conference Setup">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="template-description" rows="2"
                        placeholder="Brief description of this template"></textarea>
                </div>

                <button type="button" onclick="saveTemplate()" class="success">Create Template</button>
                <button type="button" onclick="closeTemplateModal()" class="secondary">Cancel</button>
            </form>
        </div>
    </div>

    <!-- TEMPLATE DETAILS MODAL -->
    <div id="template-details-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTemplateDetailsModal()">&times;</span>
            <div id="template-details-content"></div>
        </div>
    </div>

    <!-- EQUIPMENT HISTORY MODAL -->
    <div id="equipment-history-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEquipmentHistoryModal()">&times;</span>
            <div id="equipment-history-content"></div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photo-modal" class="modal-photo" onclick="closePhotoModal(event)">
        <div class="modal-content-photo" onclick="event.stopPropagation()">
            <span class="close" onclick="closePhotoModal()">&times;</span>
            <h2 id="modal-equipment-name"></h2>
            <img id="modal-photo" class="modal-image">
            <div style="margin-top: 15px;">
                <div class="file-input-wrapper">
                    <input type="file" id="update-photo-input" accept="image/*" onchange="updateEquipmentPhoto()">
                    <label for="update-photo-input" class="file-input-label">Change Photo</label>
                </div>
                <button onclick="deleteEquipmentPhoto()" class="danger">Delete Photo</button>
            </div>
        </div>
    </div>

    <script>
        let equipment = [];
        let events = [];
        let templates = [];
        let categories = [];
        let users = [];
        let currentUser = null;
        let currentEvent = null;
        let currentEventId = null;
        let currentTemplateId = null;
        let selectedEquipment = new Set();
        let html5QrCode = null;
        let currentPhotoEquipmentId = null;

        // Initialize
        window.onload = function () {
            loadCurrentUser();
            loadEquipment();
            loadEvents();
            loadTemplates();
            loadCategories();
            loadUsers();
        };

        // Global error handler for API authentication
        const originalFetch = window.fetch;
        window.fetch = async function (...args) {
            const response = await originalFetch(...args);

            // If unauthorized, redirect to login
            if (response.status === 401 && !args[0].includes('/api/login') && !args[0].includes('/api/current-user')) {
                window.location.href = '/login';
                throw new Error('Session expired');
            }

            return response;
        };


        // Tab management

        // ==================== CATEGORY FUNCTIONS ====================

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                categories = await response.json();
                displayCategories();
                updateCategoryDropdowns();
            } catch (error) {
                showMessage('Error loading categories: ' + error.message, 'error');
            }
        }

        function displayCategories() {
            const container = document.getElementById('categories-list');

            if (categories.length === 0) {
                container.innerHTML = '<p style="color: #666;">No categories yet. Add one above!</p>';
                return;
            }

            let html = '';
            categories.forEach(cat => {
                html += `
            <div class="category-item">
                <div style="display: flex; align-items: center; flex: 1;">
                    <div class="category-color-box" style="background-color: ${cat.color};"></div>
                    <div class="category-info">
                        <div class="category-name">${cat.name}</div>
                        ${cat.description ? `<div class="category-description">${cat.description}</div>` : ''}
                    </div>
                </div>
                <div class="category-actions">
                    <button onclick="editCategory('${cat.id}')">Edit</button>
                    <button onclick="deleteCategory('${cat.id}')" style="background: #dc3545;">Delete</button>
                </div>
            </div>
        `;
            });

            container.innerHTML = html;
        }

        async function addCategory() {
            const name = document.getElementById('new-category-name').value.trim();
            const description = document.getElementById('new-category-description').value.trim();
            const color = document.getElementById('new-category-color').value;

            if (!name) {
                alert('Please enter a category name');
                return;
            }

            try {
                const response = await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, color })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message, 'success');
                    document.getElementById('new-category-name').value = '';
                    document.getElementById('new-category-description').value = '';
                    document.getElementById('new-category-color').value = '#333333';
                    loadCategories();
                } else {
                    showMessage(result.error || 'Error adding category', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function editCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;

            const newName = prompt('Category Name:', category.name);
            if (newName === null) return; // Cancelled

            const newDescription = prompt('Description:', category.description || '');
            if (newDescription === null) return;

            const newColor = prompt('Color (hex code):', category.color);
            if (newColor === null) return;

            try {
                const response = await fetch(`/api/categories/${categoryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName.trim(),
                        description: newDescription.trim(),
                        color: newColor.trim()
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message, 'success');
                    loadCategories();
                    loadEquipment(); // Refresh equipment to show updated category names
                } else {
                    showMessage(result.error || 'Error updating category', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function deleteCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;

            if (!confirm(`Delete category "${category.name}"? Equipment with this category will be uncategorized.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/categories/${categoryId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message, 'success');
                    loadCategories();
                    loadEquipment(); // Refresh equipment list
                } else {
                    showMessage(result.error || 'Error deleting category', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function updateCategoryDropdowns() {
            // Update add equipment form dropdown
            const addDropdown = document.getElementById('new-equipment-category');
            if (addDropdown) {
                let html = '<option value="">No Category</option>';
                categories.forEach(cat => {
                    html += `<option value="${cat.id}">${cat.name}</option>`;
                });
                addDropdown.innerHTML = html;
            }

            // Update edit equipment form dropdown
            const editDropdown = document.getElementById('edit-equipment-category');
            if (editDropdown) {
                let html = '<option value="">No Category</option>';
                categories.forEach(cat => {
                    html += `<option value="${cat.id}">${cat.name}</option>`;
                });
                editDropdown.innerHTML = html;
            }

            // Update filter dropdown
            const filterDropdown = document.getElementById('filter-category');
            if (filterDropdown) {
                let html = '<option value="ALL">All Categories</option>';
                categories.forEach(cat => {
                    html += `<option value="${cat.id}">${cat.name}</option>`;
                });
                filterDropdown.innerHTML = html;
            }
        }

        // Update the addEquipment function to include category_id
        // This replaces the existing addEquipment function
        async function addEquipmentWithCategory(event) {
            if (event) event.preventDefault();

            const name = document.getElementById('new-equipment-name').value.trim();
            const quantity = parseInt(document.getElementById('new-equipment-quantity').value) || 1;
            const categoryId = document.getElementById('new-equipment-category').value;

            if (!name) {
                alert('Please enter equipment name');
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('quantity', quantity);
            if (categoryId) {
                formData.append('category_id', categoryId);
            }

            const photoFile = document.getElementById('equipment-photo').files[0];
            if (photoFile) {
                formData.append('photo', photoFile);
            }

            try {
                const response = await fetch('/api/equipment', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message, 'success');
                    document.getElementById('new-equipment-name').value = '';
                    document.getElementById('new-equipment-quantity').value = '1';
                    document.getElementById('new-equipment-category').value = '';
                    document.getElementById('equipment-photo').value = '';
                    document.getElementById('photo-filename').textContent = '';
                    document.getElementById('photo-preview-container').classList.add('hidden');
                    loadEquipment();
                } else {
                    showMessage(result.error || 'Error adding equipment', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }


        // ==================== USER MANAGEMENT FUNCTIONS ====================

        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/current-user');
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('user-info').textContent =
                        `üë§ ${currentUser.full_name || currentUser.username} (${currentUser.role})`;
                } else {
                    // Not logged in, redirect to login
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error loading user:', error);
                window.location.href = '/login';
            }
        }

        async function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;

            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                showMessage('Logout error: ' + error.message, 'error');
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    users = await response.json();
                    displayUsers();
                } else {
                    showMessage('Error loading users', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('users-list');
            if (!tbody) return;

            tbody.innerHTML = '';

            users.forEach(user => {
                const row = tbody.insertRow();

                const isCurrentUser = currentUser && user.id === currentUser.user_id;
                const roleClass = user.role === 'admin' ? 'status-out' : 'status-in';

                row.innerHTML = `
            <td><strong>${user.username}</strong>${isCurrentUser ? ' <span style="color: #28a745;">(You)</span>' : ''}</td>
            <td>${user.full_name || '-'}</td>
            <td><span class="${roleClass}" style="padding: 3px 10px; border-radius: 3px; font-size: 12px;">${user.role.toUpperCase()}</span></td>
            <td>${user.created_at || '-'}</td>
            <td>${user.last_login || 'Never'}</td>
            <td>
                <button onclick="editUser(${user.id})" style="background: #28a745;">Edit</button>
                ${!isCurrentUser ? `<button onclick="deleteUser(${user.id})" class="danger">Delete</button>` : ''}
            </td>
        `;
            });
        }

        async function createUser() {
            const username = document.getElementById('new-user-username').value.trim();
            const password = document.getElementById('new-user-password').value;
            const fullName = document.getElementById('new-user-fullname').value.trim();
            const role = document.getElementById('new-user-role').value;

            if (!username) {
                alert('Username is required');
                return;
            }

            if (!password || password.length < 4) {
                alert('Password must be at least 4 characters');
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        full_name: fullName,
                        role: role
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('User created successfully!', 'success');
                    document.getElementById('new-user-username').value = '';
                    document.getElementById('new-user-password').value = '';
                    document.getElementById('new-user-fullname').value = '';
                    document.getElementById('new-user-role').value = 'user';
                    loadUsers();
                } else {
                    showMessage(result.error || 'Error creating user', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const newFullName = prompt('Full Name:', user.full_name || '');
            if (newFullName === null) return; // Cancelled

            const newRole = prompt('Role (admin or user):', user.role);
            if (newRole === null) return;

            if (newRole !== 'admin' && newRole !== 'user') {
                alert('Role must be "admin" or "user"');
                return;
            }

            const changePassword = confirm('Do you want to change the password?');
            let newPassword = null;

            if (changePassword) {
                newPassword = prompt('New password (min 4 characters):');
                if (newPassword === null) return;

                if (newPassword && newPassword.length < 4) {
                    alert('Password must be at least 4 characters');
                    return;
                }
            }

            try {
                const body = {
                    full_name: newFullName,
                    role: newRole
                };

                if (newPassword) {
                    body.password = newPassword;
                }

                const response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('User updated successfully!', 'success');
                    loadUsers();
                } else {
                    showMessage(result.error || 'Error updating user', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            if (!confirm(`Delete user "${user.username}"? This cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('User deleted successfully', 'success');
                    loadUsers();
                } else {
                    showMessage(result.error || 'Error deleting user', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function changePassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!newPassword || newPassword.length < 4) {
                alert('Password must be at least 4 characters');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            try {
                const response = await fetch(`/api/users/${currentUser.user_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: newPassword })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Password changed successfully!', 'success');
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                } else {
                    showMessage(result.error || 'Error changing password', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Handle 401 (unauthorized) responses globally
        window.addEventListener('unhandledrejection', event => {
            if (event.reason && event.reason.status === 401) {
                window.location.href = '/login';
            }
        });


        // ==================== EQUIPMENT FUNCTIONS ====================

        async function loadEquipment() {
            try {
                const response = await fetch('/api/equipment');
                equipment = await response.json();
                displayEquipment();
                updateStats();
            } catch (error) {
                showMessage('Error loading equipment: ' + error.message, 'error');
            }
        }

        async function addEquipment(event) {
            if (event) event.preventDefault();

            const name = document.getElementById('new-equipment-name').value.trim();
            const quantity = parseInt(document.getElementById('new-equipment-quantity').value) || 1;

            if (!name) {
                alert('Please enter equipment name');
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('quantity', quantity);

            const photoFile = document.getElementById('equipment-photo').files[0];
            if (photoFile) {
                formData.append('photo', photoFile);
            }

            try {
                const response = await fetch('/api/equipment', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message + ` (Quantity: ${quantity})`, 'success');
                    document.getElementById('new-equipment-name').value = '';
                    document.getElementById('new-equipment-quantity').value = '1';
                    clearPhotoPreview();
                    loadEquipment();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error adding equipment: ' + error.message, 'error');
            }
        }

        async function bulkAddEquipment() {
            const text = document.getElementById('bulk-equipment').value.trim();
            if (!text) {
                alert('Please enter equipment names');
                return;
            }

            const names = text.split('\n').filter(name => name.trim());

            for (const name of names) {
                try {
                    await fetch('/api/equipment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name.trim() })
                    });
                } catch (error) {
                    console.error('Error adding:', name, error);
                }
            }

            showMessage(`Added ${names.length} equipment items`, 'success');
            document.getElementById('bulk-equipment').value = '';
            loadEquipment();
        }

        function updateStats() {
            const total = equipment.length;
            const inWarehouse = equipment.filter(eq => eq.status === 'IN').length;
            const out = equipment.filter(eq => eq.status === 'OUT').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-in').textContent = inWarehouse;
            document.getElementById('stat-out').textContent = out;
        }

        // ==================== SCANNER WORKFLOW FUNCTIONS ====================

        // Update event selector display
        function updateActiveEventDisplay() {
            const eventSelect = document.getElementById('scan-event-select');
            const selectedEventId = eventSelect.value;
            const activeDisplay = document.getElementById('active-event-display');
            const manualDisplay = document.getElementById('manual-mode-display');

            if (selectedEventId) {
                // Event selected - show active event display
                const event = events.find(e => e.id === selectedEventId);
                if (event) {
                    document.getElementById('active-event-name').textContent = event.name;
                    document.getElementById('active-event-details').textContent =
                        `${event.type} ‚Ä¢ ${event.date || 'No date'} ‚Ä¢ ${event.location || 'No location'}`;
                    activeDisplay.style.display = 'block';
                    manualDisplay.style.display = 'none';
                }
            } else {
                // Manual mode - show manual display
                activeDisplay.style.display = 'none';
                manualDisplay.style.display = 'block';
            }
        }

        // Event selector change handler
        document.addEventListener('DOMContentLoaded', function () {
            const eventSelect = document.getElementById('scan-event-select');
            if (eventSelect) {
                eventSelect.addEventListener('change', updateActiveEventDisplay);
            }
        });

        function clearActiveEvent() {
            document.getElementById('scan-event-select').value = '';
            updateActiveEventDisplay();
            showMessage('Switched to manual mode', 'success');
        }

        function refreshEventsList() {
            loadEvents();
            showMessage('Events list refreshed', 'success');
        }

        // Quick create event modal
        function quickCreateEvent() {
            document.getElementById('quick-event-modal').style.display = 'block';
            document.getElementById('quick-event-name').focus();
        }

        function closeQuickEventModal() {
            document.getElementById('quick-event-modal').style.display = 'none';
            document.getElementById('quick-event-form').reset();
        }

        async function submitQuickEvent(event) {
            event.preventDefault();

            const name = document.getElementById('quick-event-name').value.trim();
            const type = document.getElementById('quick-event-type').value;
            const date = document.getElementById('quick-event-date').value;
            const location = document.getElementById('quick-event-location').value.trim();

            if (!name || !type) {
                alert('Event name and type are required');
                return;
            }

            try {
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        type: type,
                        date: date,
                        location: location,
                        status: 'upcoming'
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Event created successfully!', 'success');
                    closeQuickEventModal();

                    // Reload events
                    await loadEvents();

                    // Auto-select the new event in the scanner
                    document.getElementById('scan-event-select').value = result.id;
                    updateActiveEventDisplay();

                    showMessage(`Now scanning for event: ${name}`, 'success');
                } else {
                    showMessage(result.error || 'Error creating event', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Manual scan
        function processManualScan() {
            const code = document.getElementById('manual-code').value.trim();
            if (code) {
                processCode(code);
                document.getElementById('manual-code').value = '';
            }
        }

        // Helper function to select event during scan
        async function selectEventForScan(equipmentName) {
            // Get active events (Planning or Active status)
            const activeEvents = events.filter(e => e.status === 'PLANNING' || e.status === 'ACTIVE' || e.status === 'upcoming');

            if (activeEvents.length === 0) {
                // No events available, ask for manual location
                const manualLocation = prompt(`No active events found.\n\nWhere is "${equipmentName}" going?`, 'Event Location');
                return { eventId: null, location: manualLocation };
            }

            // Build options for user to choose
            let message = `Where is "${equipmentName}" going?\n\n`;
            message += '0: Manual location (no event)\n';
            activeEvents.forEach((event, index) => {
                message += `${index + 1}: ${event.name} - ${event.date || 'No date'}\n`;
            });
            message += '\nEnter number:';

            const choice = prompt(message, '0');

            if (choice === null) {
                // User cancelled
                return null;
            }

            const choiceNum = parseInt(choice);

            if (choiceNum === 0 || isNaN(choiceNum)) {
                // Manual location
                const manualLocation = prompt(`Where is "${equipmentName}" going?`, 'Event Location');
                return { eventId: null, location: manualLocation };
            }

            if (choiceNum > 0 && choiceNum <= activeEvents.length) {
                // Event selected
                const selectedEvent = activeEvents[choiceNum - 1];
                return {
                    eventId: selectedEvent.id,
                    location: selectedEvent.location || selectedEvent.name
                };
            }

            // Invalid choice
            alert('Invalid selection');
            return null;
        }

        // Camera scanner
        function startCameraScanner() {
            html5QrCode = new Html5Qrcode("scanner-container");

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    processCode(decodedText);
                    stopCameraScanner();
                }
            ).then(() => {
                document.getElementById('scanner-container').classList.remove('hidden');
                document.getElementById('stop-camera-btn').classList.remove('hidden');
            }).catch(err => {
                showMessage('Error starting camera: ' + err, 'error');
            });
        }

        function stopCameraScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-container').classList.add('hidden');
                    document.getElementById('stop-camera-btn').classList.add('hidden');
                });
            }
        }

        // Process scanned code
        async function processCode(code) {
            const userName = document.getElementById('scanner-user-name')?.value.trim();
            if (!userName) {
                alert('Please enter your name before scanning');
                document.getElementById('scanner-user-name')?.focus();
                return;
            }

            let location = '';
            let quantity = 1;
            let eventId = document.getElementById('scan-event-select')?.value || '';

            // Find the equipment
            const item = equipment.find(eq => eq.id === code);

            if (!item) {
                showMessage('Equipment not found', 'error');
                return;
            }

            const total = item.quantity || 1;
            const currentOut = item.quantity_out || 0;
            const available = total - currentOut;

            let checkingOut = undefined; // Will be set based on user choice or status

            // If multiple quantity items, ask how many
            if (total > 1) {

                if (item.status === 'IN') {
                    // All items in warehouse, must be checking OUT
                    checkingOut = true;
                } else if (item.status === 'OUT') {
                    // All items out, must be checking IN
                    checkingOut = false;
                } else if (item.status === 'PARTIAL') {
                    // Some in, some out - ask user what they want to do
                    const action = confirm(
                        `${item.name}: ${available} in warehouse, ${currentOut} checked out.\n\n` +
                        `Click OK to CHECK OUT more items.\n` +
                        `Click CANCEL to CHECK IN returning items.`
                    );
                    checkingOut = action; // true = check out, false = check in
                }

                if (checkingOut) {
                    // Checking out
                    quantity = prompt(`How many ${item.name} to check out? (Available: ${available})`, '1');
                    if (quantity === null) return; // Cancelled
                    quantity = parseInt(quantity) || 1;

                    if (quantity > available) {
                        alert(`Only ${available} available!`);
                        return;
                    }

                    // If no event pre-selected, let user choose event
                    if (!eventId) {
                        const selection = await selectEventForScan(item.name);
                        if (selection === null) return; // Cancelled
                        eventId = selection.eventId || '';
                        location = selection.location || 'Unknown';
                    } else {
                        // Event was pre-selected, use its location
                        const event = events.find(e => e.id === eventId);
                        location = event ? (event.location || event.name) : 'Event';
                    }
                } else {
                    // Checking in
                    quantity = prompt(`How many ${item.name} to check in? (Out: ${currentOut})`, currentOut);
                    if (quantity === null) return; // Cancelled
                    quantity = parseInt(quantity) || 1;

                    if (quantity > currentOut) {
                        quantity = currentOut;
                    }
                }
            } else {
                // Single item - original behavior
                if (item.status === 'IN') {
                    checkingOut = true;
                    if (!eventId) {
                        const selection = await selectEventForScan(item.name);
                        if (selection === null) return; // Cancelled
                        eventId = selection.eventId || '';
                        location = selection.location || 'Unknown';
                    } else {
                        // Event was pre-selected, use its location
                        const event = events.find(e => e.id === eventId);
                        location = event ? (event.location || event.name) : 'Event';
                    }
                } else if (item.status === 'OUT' || item.status === 'PARTIAL') {
                    checkingOut = false;
                }
            }

            // Determine the action to send to backend
            let explicitAction = 'CHECK_OUT';  // default
            if (checkingOut !== undefined) {
                // For multi-quantity items where we asked the user
                explicitAction = checkingOut ? 'CHECK_OUT' : 'CHECK_IN';
            } else {
                // For single items
                if (item.status === 'OUT' || (item.status === 'PARTIAL' && currentOut > 0 && !checkingOut)) {
                    explicitAction = 'CHECK_IN';
                }
            }

            try {
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: code,
                        location: location,
                        event_id: eventId,
                        scanned_by: userName,
                        quantity: quantity,
                        action: explicitAction
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message, 'success');
                    loadEquipment();
                    loadRecentActivity();
                    if (eventId) {
                        loadEvents();
                    }
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error processing scan: ' + error.message, 'error');
            }
        }

        // Show message
        function showMessage(message, type) {
            const resultDiv = document.getElementById('scan-result');
            resultDiv.textContent = message;
            resultDiv.className = 'message message-' + type;
            resultDiv.classList.remove('hidden');

            setTimeout(() => {
                resultDiv.classList.add('hidden');
            }, 5000);
        }

        // Display equipment list
        function displayEquipment() {
            const tbody = document.getElementById('equipment-list');
            tbody.innerHTML = '';

            let filteredEquipment = [...equipment];

            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const categoryFilter = document.getElementById('filter-category')?.value || 'ALL';

            if (searchTerm) {
                filteredEquipment = filteredEquipment.filter(item =>
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.id.toLowerCase().includes(searchTerm)
                );
            }

            if (statusFilter !== 'ALL') {
                filteredEquipment = filteredEquipment.filter(item => item.status === statusFilter);

                if (categoryFilter !== 'ALL') {
                    filteredEquipment = filteredEquipment.filter(item => item.category_id === categoryFilter);
                }
            }

            filteredEquipment.forEach(item => {
                const row = tbody.insertRow();

                // Determine row class based on status
                let rowClass = 'status-in';
                if (item.status === 'OUT') rowClass = 'status-out';
                if (item.status === 'PARTIAL') rowClass = 'status-partial';
                row.className = rowClass;

                // Photo cell
                const photoCell = row.insertCell();
                if (item.photo) {
                    photoCell.innerHTML = `<img src="/uploads/photos/${item.photo}" class="equipment-photo" onclick="openPhotoModal('${item.id}')" alt="${item.name}">`;
                } else {
                    photoCell.innerHTML = `<div class="no-photo" onclick="openPhotoModal('${item.id}', true)">üì∑</div>`;
                }

                // Calculate quantities
                const total = item.quantity || 1;
                const out = item.quantity_out || 0;
                const available = total - out;

                // Quantity badge
                let qtyBadgeClass = 'full';
                if (out === total) qtyBadgeClass = 'out';
                else if (out > 0) qtyBadgeClass = 'partial';

                const quantityDisplay = total > 1
                    ? `<span class="quantity-badge ${qtyBadgeClass}">${available}/${total} available</span>`
                    : `<span class="quantity-badge full">1</span>`;

                // Rest of the row
                row.innerHTML += `
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>${item.category_name ? '<span class="category-badge" style="background-color: ' + (item.category_color || '#333') + '; color: white;">' + item.category_name + '</span>' : '<span style="color: #999;">Uncategorized</span>'}</td>
            <td>${quantityDisplay}</td>
            <td><strong>${item.status}</strong></td>
            <td>${item.location}</td>
            <td>${item.last_updated}</td>
            <td>
                <button onclick="openEditEquipmentModal('${item.id}')" style="background: #28a745;">Edit</button>
                <button onclick="showEquipmentQRCode('${item.id}', '${item.name}')" style="background: #6f42c1;">QR Code</button>
                <button onclick="viewEquipmentHistory('${item.id}', '${item.name}')" class="secondary">View History</button>
                <button onclick="deleteEquipment('${item.id}')" class="danger">Delete</button>
            </td>
        `;
            });
        }

        // Filter equipment
        function filterEquipment() {
            displayEquipment();
        }

        // Delete equipment
        async function deleteEquipment(id) {
            if (!confirm('Delete this equipment?')) return;

            try {
                const response = await fetch(`/api/equipment/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Equipment deleted', 'success');
                    loadEquipment();
                } else {
                    showMessage('Error deleting equipment', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Edit equipment functions
        let currentEditEquipmentId = null;

        function openEditEquipmentModal(equipmentId) {
            currentEditEquipmentId = equipmentId;
            const item = equipment.find(eq => eq.id === equipmentId);

            if (!item) {
                showMessage('Equipment not found', 'error');
                return;
            }

            // Populate form fields
            document.getElementById('edit-equipment-name').value = item.name;
            document.getElementById('edit-equipment-quantity').value = item.quantity || 1;
            document.getElementById('edit-equipment-category').value = item.category_id || '';
            document.getElementById('edit-equipment-status').value = item.status;

            // Show modal
            document.getElementById('edit-equipment-modal').style.display = 'block';
        }

        function closeEditEquipmentModal() {
            document.getElementById('edit-equipment-modal').style.display = 'none';
            currentEditEquipmentId = null;
        }

        async function saveEquipmentChanges(event) {
            if (event) event.preventDefault();

            if (!currentEditEquipmentId) return;

            const name = document.getElementById('edit-equipment-name').value.trim();
            const quantity = parseInt(document.getElementById('edit-equipment-quantity').value);
            const category_id = document.getElementById('edit-equipment-category').value;

            if (!name) {
                alert('Please enter equipment name');
                return;
            }

            if (quantity < 1) {
                alert('Quantity must be at least 1');
                return;
            }

            try {
                const response = await fetch(`/api/equipment/${currentEditEquipmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        quantity: quantity,
                        category_id: category_id || null
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Equipment updated successfully!', 'success');
                    closeEditEquipmentModal();
                    loadEquipment();
                } else {
                    showMessage(result.error || 'Error updating equipment', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Close modal when clicking outside of it
        window.onclick = function (event) {
            const editModal = document.getElementById('edit-equipment-modal');
            if (event.target == editModal) {
                closeEditEquipmentModal();
            }
        }

        // Export data as JSON
        async function exportData() {
            try {
                const response = await fetch('/api/export');
                const data = await response.json();

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'equipment-backup-' + new Date().toISOString().split('T')[0] + '.json';
                link.click();

                showMessage('Backup downloaded successfully', 'success');
            } catch (error) {
                showMessage('Error exporting data: ' + error.message, 'error');
            }
        }

        // Export as CSV
        async function exportCSV() {
            try {
                const response = await fetch('/api/export');
                const data = await response.json();

                let csv = 'ID,Name,Status,Location,Last Updated\n';
                data.forEach(item => {
                    csv += `"${item.id}","${item.name}","${item.status}","${item.location}","${item.last_updated}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'equipment-' + new Date().toISOString().split('T')[0] + '.csv';
                link.click();

                showMessage('CSV downloaded successfully', 'success');
            } catch (error) {
                showMessage('Error exporting CSV: ' + error.message, 'error');
            }
        }

        // Import data
        async function importData() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    const response = await fetch('/api/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ equipment: data })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showMessage(result.message, 'success');
                        loadEquipment();
                    } else {
                        showMessage('Error: ' + result.error, 'error');
                    }
                } catch (error) {
                    showMessage('Error importing data: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Generate QR codes
        function generateAllQRCodes() {
            const container = document.getElementById('qr-codes-container');
            container.innerHTML = '<p>Generating barcodes...</p>';

            setTimeout(() => {
                container.innerHTML = '';

                equipment.forEach(item => {
                    const barcodeDiv = document.createElement('div');
                    barcodeDiv.className = 'qr-code';

                    // Add photo if available
                    let photoHtml = '';
                    if (item.photo) {
                        photoHtml = `<img src="/uploads/photos/${item.photo}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px; margin-bottom: 10px;">`;
                    }

                    barcodeDiv.innerHTML = `
                ${photoHtml}
                <h3>${item.name}</h3>
                <div style="margin: 20px 0;">
                    <strong>Barcode:</strong><br>
                    <img src="https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(item.id)}&code=Code128&translate-esc=on&eclevel=L" alt="Barcode" style="max-width: 300px; height: auto;">
                </div>
                <p><strong>ID: ${item.id}</strong></p>
            `;
                    container.appendChild(barcodeDiv);
                });

                document.getElementById('print-btn').classList.remove('hidden');
                showMessage('Barcodes generated! Ready to print.', 'success');
            }, 100);
        }

        // ==================== INDIVIDUAL QR CODE FUNCTIONS ====================

        function showEquipmentQRCode(equipmentId, equipmentName) {
            const item = equipment.find(eq => eq.id === equipmentId);
            if (!item) {
                showMessage('Equipment not found', 'error');
                return;
            }

            // Set modal title
            document.getElementById('qrcode-equipment-name').textContent = `QR Code - ${equipmentName}`;

            // Generate QR code
            const container = document.getElementById('single-qr-container');
            container.innerHTML = `
                <div class="single-qr-item">
                    ${item.photo ? `<img src="/uploads/photos/${item.photo}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 5px; margin-bottom: 15px;">` : ''}
                    <div class="single-qr-label">${item.name}</div>
                    <div style="margin: 20px 0;">
                        <img src="https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(item.id)}&code=Code128&translate-esc=on&eclevel=L" 
                             alt="Barcode" 
                             style="max-width: 100%; height: auto;">
                    </div>
                    <p style="font-size: 14px; margin-top: 10px;"><strong>ID: ${item.id}</strong></p>
                </div>
            `;

            // Show modal
            document.getElementById('qrcode-modal').style.display = 'block';
        }

        function closeQRCodeModal() {
            document.getElementById('qrcode-modal').style.display = 'none';
        }

        function printSingleQRCode() {
            window.print();
        }

        // Close modal when clicking outside
        window.addEventListener('click', function (event) {
            const qrModal = document.getElementById('qrcode-modal');
            if (event.target == qrModal) {
                closeQRCodeModal();
            }
        });

        // ==================== EVENTS FUNCTIONS ====================

        async function loadEvents() {
            try {
                const response = await fetch('/api/events');
                events = await response.json();
                displayEvents();
                loadEventsForScan(); // Also update scanner dropdown
            } catch (error) {
                showMessage('Error loading events: ' + error.message, 'error');
            }
        }

        async function loadEventsForScan() {
            try {
                const response = await fetch('/api/events');
                events = await response.json();

                const select = document.getElementById('scan-event-select');
                select.innerHTML = '<option value="">No Event (Manual Check In/Out)</option>';

                // Only show PLANNING and ACTIVE events
                events.filter(e => e.status === 'PLANNING' || e.status === 'ACTIVE')
                    .forEach(event => {
                        const option = document.createElement('option');
                        option.value = event.id;
                        option.textContent = `${event.name} (${event.date})`;
                        select.appendChild(option);
                    });
            } catch (error) {
                console.error('Error loading events for scan:', error);
            }
        }

        function displayEvents() {
            const container = document.getElementById('events-list');
            container.innerHTML = '';

            let filteredEvents = [...events];
            const statusFilter = document.getElementById('event-filter-status').value;

            if (statusFilter !== 'ALL') {
                filteredEvents = filteredEvents.filter(e => e.status === statusFilter);
            }

            if (filteredEvents.length === 0) {
                container.innerHTML = '<p>No events found. Create your first event!</p>';
                return;
            }

            filteredEvents.forEach(event => {
                const card = document.createElement('div');
                card.className = 'event-card event-' + event.status.toLowerCase();
                card.onclick = () => viewEventDetails(event.id);

                const badgeClass = 'badge-' + event.status.toLowerCase();

                card.innerHTML = `
                    <div class="event-header">
                        <div>
                            <div class="event-title">${event.name}</div>
                            <div class="event-meta">
                                üìÖ ${event.date} | üìç ${event.location || 'No location'} | 
                                <span class="badge ${badgeClass}">${event.status}</span>
                            </div>
                            <div class="event-meta" style="margin-top: 5px;">
                                <strong>Type:</strong> ${event.type}
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function filterEvents() {
            displayEvents();
        }

        function showCreateEventModal() {
            currentEventId = null;
            document.getElementById('event-modal-title').textContent = 'Create New Event';
            document.getElementById('event-form').reset();
            updateTemplateSelects(); // Make sure templates dropdown is populated
            document.getElementById('event-modal').style.display = 'block';
        }

        function closeEventModal() {
            document.getElementById('event-modal').style.display = 'none';
        }

        async function viewEventDetails(eventId) {
            try {
                const response = await fetch(`/api/events/${eventId}`);
                const data = await response.json();

                if (!response.ok) {
                    showMessage('Error loading event details', 'error');
                    return;
                }

                currentEvent = data.event;
                const checklist = data.checklist;

                // Calculate progress
                const total = checklist.length;
                const checkedOut = checklist.filter(item => item.checked_out).length;
                const checkedIn = checklist.filter(item => item.checked_in).length;
                const progress = total > 0 ? Math.round((checkedOut / total) * 100) : 0;

                const badgeClass = 'badge-' + currentEvent.status.toLowerCase();

                let content = `
                    <h2>${currentEvent.name}</h2>
                    <div style="margin-bottom: 20px;">
                        <span class="badge ${badgeClass}">${currentEvent.status}</span>
                        <p><strong>Type:</strong> ${currentEvent.type}</p>
                        <p><strong>Date:</strong> ${currentEvent.date}</p>
                        <p><strong>Location:</strong> ${currentEvent.location || 'Not specified'}</p>
                        <p><strong>Notes:</strong> ${currentEvent.notes || 'None'}</p>
                    </div>
                    
                    <h3>Equipment Checklist (${total} items)</h3>
                    
                    <div style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 12px; margin: 15px 0; border-radius: 4px;">
                        <strong>Scan to Update:</strong> Go to the Scanner tab, select this event, and scan equipment barcodes to update this checklist automatically.
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%">${progress}%</div>
                    </div>
                    <p style="color: #666; margin: 10px 0;">${checkedOut} checked out | ${checkedIn} returned</p>
                    
                    <div style="margin: 15px 0;">
                        <button onclick="showAddEquipmentToEvent('${eventId}')" class="success">+ Add Equipment</button>
                        <button onclick="updateEventStatus('${eventId}', 'ACTIVE')" class="secondary" ${currentEvent.status === 'ACTIVE' ? 'disabled' : ''}>Mark as Active</button>
                        <button onclick="updateEventStatus('${eventId}', 'COMPLETED')" class="secondary" ${currentEvent.status === 'COMPLETED' ? 'disabled' : ''}>Mark as Completed</button>
                        <button onclick="deleteEvent('${eventId}')" class="danger">Delete Event</button>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
                `;

                if (checklist.length === 0) {
                    content += '<p>No equipment added yet. Click "Add Equipment" to start building your checklist.</p>';
                } else {
                    checklist.forEach(item => {
                        // Determine the status and styling
                        let itemClass = 'not-started';
                        let statusBadgeClass = 'not-started';
                        let statusText = 'Pending';

                        if (item.checked_out && item.checked_in) {
                            itemClass = 'completed';
                            statusBadgeClass = 'completed';
                            statusText = 'Complete';
                        } else if (item.checked_out) {
                            itemClass = 'checked-out';
                            statusBadgeClass = 'checked-out';
                            statusText = 'Out';
                        }

                        content += `
                            <div class="checklist-item ${itemClass}">
                                <div style="flex: 1;">
                                    ${item.photo ? `<img src="/uploads/photos/${item.photo}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 3px; margin-right: 10px; float: left;">` : ''}
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <strong style="font-size: 16px;">${item.name}</strong>
                                        <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                                    </div>
                                    <div style="margin-top: 5px; color: #666; font-size: 13px;">
                                        ${item.equipment_id}
                                    </div>
                                    ${item.notes ? `<div style="margin-top: 8px; padding: 8px; background: #fff9e6; border-left: 3px solid #ffc107; font-size: 13px;">${item.notes}</div>` : ''}
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <button onclick="removeFromChecklist('${eventId}', ${item.id})" class="danger" style="padding: 10px 20px;">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }

                content += '</div>';

                document.getElementById('event-details-content').innerHTML = content;
                document.getElementById('event-details-modal').style.display = 'block';
            } catch (error) {
                showMessage('Error loading event details: ' + error.message, 'error');
            }
        }

        function closeEventDetailsModal() {
            document.getElementById('event-details-modal').style.display = 'none';
        }

        async function updateEventStatus(eventId, status) {
            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    showMessage('Event status updated', 'success');
                    closeEventDetailsModal();
                    loadEvents();
                } else {
                    showMessage('Error updating event status', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Delete this event and its checklist?')) return;

            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Event deleted', 'success');
                    closeEventDetailsModal();
                    loadEvents();
                } else {
                    showMessage('Error deleting event', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function showAddEquipmentToEvent(eventId) {
            currentEventId = eventId;
            selectedEquipment.clear();
            displayEquipmentForSelection();
            document.getElementById('add-equipment-modal').style.display = 'block';
        }

        function closeAddEquipmentModal() {
            document.getElementById('add-equipment-modal').style.display = 'none';
        }

        function displayEquipmentForSelection() {
            const container = document.getElementById('equipment-select-list');
            container.innerHTML = '';

            const searchTerm = document.getElementById('equipment-search').value.toLowerCase();

            let filteredEquipment = equipment.filter(eq =>
                eq.name.toLowerCase().includes(searchTerm) ||
                eq.id.toLowerCase().includes(searchTerm)
            );

            filteredEquipment.forEach(item => {
                const div = document.createElement('div');
                div.className = 'equipment-select-item';
                if (selectedEquipment.has(item.id)) {
                    div.classList.add('selected');
                }
                div.textContent = `${item.name} (${item.id}) - ${item.status}`;
                div.onclick = () => toggleEquipmentSelection(item.id, div);
                container.appendChild(div);
            });
        }

        function searchEquipmentForEvent() {
            displayEquipmentForSelection();
        }

        function toggleEquipmentSelection(equipmentId, element) {
            if (selectedEquipment.has(equipmentId)) {
                selectedEquipment.delete(equipmentId);
                element.classList.remove('selected');
            } else {
                selectedEquipment.add(equipmentId);
                element.classList.add('selected');
            }
        }

        async function addSelectedEquipmentToEvent() {
            if (selectedEquipment.size === 0) {
                alert('Please select at least one equipment item');
                return;
            }

            for (const equipmentId of selectedEquipment) {
                try {
                    await fetch(`/api/events/${currentEventId}/checklist`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ equipment_id: equipmentId })
                    });
                } catch (error) {
                    console.error('Error adding equipment:', error);
                }
            }

            showMessage(`Added ${selectedEquipment.size} items to checklist`, 'success');
            closeAddEquipmentModal();
            viewEventDetails(currentEventId);
        }

        async function removeFromChecklist(eventId, itemId) {
            if (!confirm('Remove this equipment from the checklist?')) return;

            try {
                const response = await fetch(`/api/events/${eventId}/checklist/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Equipment removed from checklist', 'success');
                    viewEventDetails(eventId);
                } else {
                    showMessage('Error removing equipment', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // ==================== TEMPLATES FUNCTIONS ====================

        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                templates = await response.json();
                displayTemplates();
                updateTemplateSelects();
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }

        function displayTemplates() {
            const container = document.getElementById('templates-list');
            if (!container) return;

            container.innerHTML = '';

            if (templates.length === 0) {
                container.innerHTML = '<p>No templates created yet. Create your first template to save time on future events!</p>';
                return;
            }

            templates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'event-card';
                card.onclick = () => viewTemplateDetails(template.id);

                card.innerHTML = `
                    <div class="event-header">
                        <div>
                            <div class="event-title">${template.name}</div>
                            <div class="event-meta">
                                ${template.description || 'No description'}
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function showCreateTemplateModal() {
            document.getElementById('template-form').reset();
            document.getElementById('template-modal').style.display = 'block';
        }

        function closeTemplateModal() {
            document.getElementById('template-modal').style.display = 'none';
        }

        function closeTemplateDetailsModal() {
            document.getElementById('template-details-modal').style.display = 'none';
        }

        async function saveTemplate() {
            const name = document.getElementById('template-name').value.trim();
            const description = document.getElementById('template-description').value.trim();

            if (!name) {
                alert('Please enter template name');
                return;
            }

            try {
                const response = await fetch('/api/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('Template created successfully', 'success');
                    closeTemplateModal();
                    loadTemplates();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error creating template: ' + error.message, 'error');
            }
        }

        async function viewTemplateDetails(templateId) {
            try {
                const response = await fetch(`/api/templates/${templateId}`);
                const data = await response.json();

                if (!response.ok) {
                    showMessage('Error loading template details', 'error');
                    return;
                }

                currentTemplateId = templateId;
                const template = data.template;
                const items = data.items;

                let content = `
                    <h2>${template.name}</h2>
                    <p style="color: #666; margin-bottom: 20px;">${template.description || 'No description'}</p>
                    
                    <h3>Equipment List (${items.length} items)</h3>
                    
                    <div style="margin: 15px 0;">
                        <button onclick="showAddEquipmentToTemplate('${templateId}')" class="success">+ Add Equipment</button>
                        <button onclick="deleteTemplate('${templateId}')" class="danger">Delete Template</button>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
                `;

                if (items.length === 0) {
                    content += '<p>No equipment added yet. Click "Add Equipment" to start building this template.</p>';
                } else {
                    // Get equipment details for template items
                    items.forEach(item => {
                        const eq = equipment.find(e => e.id === item.equipment_id);
                        if (eq) {
                            content += `
                                <div class="checklist-item not-started">
                                    <div style="flex: 1;">
                                        <strong style="font-size: 16px;">${eq.name}</strong>
                                        <div style="margin-top: 5px; color: #666; font-size: 13px;">
                                            ${eq.id}
                                        </div>
                                    </div>
                                    <div>
                                        <button onclick="removeFromTemplate('${templateId}', ${item.id})" class="danger" style="padding: 10px 20px;">
                                            Remove
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                }

                content += '</div>';

                document.getElementById('template-details-content').innerHTML = content;
                document.getElementById('template-details-modal').style.display = 'block';
            } catch (error) {
                showMessage('Error loading template details: ' + error.message, 'error');
            }
        }

        function showAddEquipmentToTemplate(templateId) {
            currentTemplateId = templateId;
            selectedEquipment.clear();
            displayEquipmentForSelection();
            document.getElementById('add-equipment-modal').style.display = 'block';
        }

        async function addSelectedEquipmentToTemplate() {
            if (selectedEquipment.size === 0) {
                alert('Please select at least one equipment item');
                return;
            }

            for (const equipmentId of selectedEquipment) {
                try {
                    await fetch(`/api/templates/${currentTemplateId}/items`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ equipment_id: equipmentId })
                    });
                } catch (error) {
                    console.error('Error adding equipment:', error);
                }
            }

            showMessage(`Added ${selectedEquipment.size} items to template`, 'success');
            closeAddEquipmentModal();
            viewTemplateDetails(currentTemplateId);
        }

        async function removeFromTemplate(templateId, itemId) {
            if (!confirm('Remove this equipment from the template?')) return;

            try {
                const response = await fetch(`/api/templates/${templateId}/items/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Equipment removed from template', 'success');
                    viewTemplateDetails(templateId);
                    loadTemplates();
                } else {
                    showMessage('Error removing equipment', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function deleteTemplate(templateId) {
            if (!confirm('Delete this template? This cannot be undone.')) return;

            try {
                const response = await fetch(`/api/templates/${templateId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Template deleted', 'success');
                    closeTemplateDetailsModal();
                    loadTemplates();
                } else {
                    showMessage('Error deleting template', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function updateTemplateSelects() {
            const select = document.getElementById('event-template');
            const hint = document.getElementById('no-templates-hint');
            if (!select) return;

            select.innerHTML = '<option value="">None - I\'ll add equipment manually</option>';
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                select.appendChild(option);
            });

            // Show hint if no templates exist
            if (hint) {
                hint.style.display = templates.length === 0 ? 'block' : 'none';
            }
        }

        function goToTemplatesTab() {
            closeEventModal();
            showTab('templates');
        }

        // Update saveEvent to apply template if selected
        async function saveEvent() {
            const name = document.getElementById('event-name').value.trim();
            const type = document.getElementById('event-type').value;
            const date = document.getElementById('event-date').value;
            const location = document.getElementById('event-location').value.trim();
            const notes = document.getElementById('event-notes').value.trim();
            const templateId = document.getElementById('event-template')?.value;

            if (!name || !type || !date) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, type, date, location, notes })
                });

                const data = await response.json();

                if (response.ok) {
                    // If template selected, apply it
                    if (templateId) {
                        const templateResponse = await fetch(`/api/events/${data.id}/apply-template/${templateId}`, {
                            method: 'POST'
                        });
                        const templateData = await templateResponse.json();
                        showMessage(`Event created! ${templateData.added} items added from template`, 'success');
                    } else {
                        showMessage('Event created successfully', 'success');
                    }

                    closeEventModal();
                    loadEvents();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error creating event: ' + error.message, 'error');
            }
        }

        // Update showAddEquipmentToEvent to differentiate from template
        function showAddEquipmentToEvent(eventId) {
            currentEventId = eventId;
            currentTemplateId = null;
            selectedEquipment.clear();
            displayEquipmentForSelection();
            document.getElementById('add-equipment-modal').style.display = 'block';
        }

        // Update addSelectedEquipmentToEvent to handle both events and templates
        async function addSelectedEquipmentToEvent() {
            if (selectedEquipment.size === 0) {
                alert('Please select at least one equipment item');
                return;
            }

            // Check if we're adding to template or event
            if (currentTemplateId) {
                return addSelectedEquipmentToTemplate();
            }

            for (const equipmentId of selectedEquipment) {
                try {
                    await fetch(`/api/events/${currentEventId}/checklist`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ equipment_id: equipmentId })
                    });
                } catch (error) {
                    console.error('Error adding equipment:', error);
                }
            }

            showMessage(`Added ${selectedEquipment.size} items to checklist`, 'success');
            closeAddEquipmentModal();
            viewEventDetails(currentEventId);
        }

        // Update showTab to load templates when tab is shown
        function showTab(tabName, clickedElement) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');

            // Activate the clicked nav tab if provided
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else {
                // Find and activate the corresponding nav tab
                const navTabs = document.querySelectorAll('.nav-tab');
                const tabIndex = ['equipment', 'events', 'templates', 'scan'].indexOf(tabName);
                if (tabIndex >= 0 && navTabs[tabIndex]) {
                    navTabs[tabIndex].classList.add('active');
                }
            }

            // Load data if needed
            if (tabName === 'events') {
                loadEvents();
            } else if (tabName === 'templates') {
                loadTemplates();
            } else if (tabName === 'scan') {
                loadEventsForScan();
                loadRecentActivity();
            }
        }

        // ==================== HISTORY FUNCTIONS ====================

        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/history?limit=20');
                const history = await response.json();

                const container = document.getElementById('recent-activity');
                if (!container) return;

                if (history.length === 0) {
                    container.innerHTML = '<p>No recent activity</p>';
                    return;
                }

                let html = '<table><thead><tr><th>Time</th><th>Equipment</th><th>Action</th><th>Event</th><th>Location</th><th>Scanned By</th></tr></thead><tbody>';

                history.forEach(item => {
                    const actionClass = item.action === 'CHECK_OUT' ? 'status-out' : 'status-in';
                    const actionText = item.action === 'CHECK_OUT' ? 'OUT' : 'IN';
                    const eventText = item.event_name || '-';

                    html += `
                        <tr class="${actionClass}">
                            <td>${item.timestamp}</td>
                            <td>${item.equipment_name || item.equipment_id}</td>
                            <td><strong>${actionText}</strong></td>
                            <td>${eventText}</td>
                            <td>${item.location}</td>
                            <td><strong>${item.scanned_by}</strong></td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        async function viewEquipmentHistory(equipmentId, equipmentName) {
            try {
                const response = await fetch(`/api/equipment/${equipmentId}/history`);
                const history = await response.json();

                let content = `
                    <h2>History: ${equipmentName}</h2>
                    <p style="color: #666; margin-bottom: 20px;">ID: ${equipmentId}</p>
                `;

                if (history.length === 0) {
                    content += '<p>No history found for this equipment.</p>';
                } else {
                    content += `
                        <table>
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Action</th>
                                    <th>Event</th>
                                    <th>Location</th>
                                    <th>Scanned By</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    history.forEach(item => {
                        const actionClass = item.action === 'CHECK_OUT' ? 'status-out' : 'status-in';
                        const actionText = item.action === 'CHECK_OUT' ? '‚úó Checked OUT' : '‚úì Checked IN';
                        const eventText = item.event_name || '-';

                        content += `
                            <tr class="${actionClass}">
                                <td>${item.timestamp}</td>
                                <td><strong>${actionText}</strong></td>
                                <td>${eventText}</td>
                                <td>${item.location}</td>
                                <td><strong>${item.scanned_by}</strong></td>
                            </tr>
                        `;
                    });

                    content += '</tbody></table>';
                }

                document.getElementById('equipment-history-content').innerHTML = content;
                document.getElementById('equipment-history-modal').style.display = 'block';
            } catch (error) {
                showMessage('Error loading equipment history: ' + error.message, 'error');
            }
        }

        function closeEquipmentHistoryModal() {
            document.getElementById('equipment-history-modal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function (event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        // ==================== PHOTO FUNCTIONS ====================

        // Photo preview
        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('photo-preview').src = e.target.result;
                    document.getElementById('photo-preview-container').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
                document.getElementById('photo-filename').textContent = file.name;
            }
        }

        // Clear photo preview
        function clearPhotoPreview() {
            document.getElementById('equipment-photo').value = '';
            document.getElementById('photo-preview').src = '';
            document.getElementById('photo-preview-container').classList.add('hidden');
            document.getElementById('photo-filename').textContent = '';
        }

        // Open photo modal
        function openPhotoModal(equipmentId, noPhoto = false) {
            const item = equipment.find(e => e.id === equipmentId);
            if (!item) return;

            currentPhotoEquipmentId = equipmentId;
            document.getElementById('modal-equipment-name').textContent = item.name;

            if (item.photo && !noPhoto) {
                document.getElementById('modal-photo').src = `/uploads/photos/${item.photo}`;
                document.getElementById('modal-photo').style.display = 'block';
            } else {
                document.getElementById('modal-photo').style.display = 'none';
            }

            document.getElementById('photo-modal').style.display = 'block';
        }

        // Close photo modal
        function closePhotoModal(event) {
            if (!event || event.target.classList.contains('modal-photo')) {
                document.getElementById('photo-modal').style.display = 'none';
                currentPhotoEquipmentId = null;
            }
        }

        // Update equipment photo
        async function updateEquipmentPhoto() {
            const fileInput = document.getElementById('update-photo-input');
            const file = fileInput.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('photo', file);

            try {
                const response = await fetch(`/api/equipment/${currentPhotoEquipmentId}/photo`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message, 'success');
                    loadEquipment();
                    closePhotoModal();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error updating photo: ' + error.message, 'error');
            }

            fileInput.value = '';
        }

        // Delete equipment photo
        async function deleteEquipmentPhoto() {
            if (!confirm('Delete this photo?')) return;

            try {
                const response = await fetch(`/api/equipment/${currentPhotoEquipmentId}/photo`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message, 'success');
                    loadEquipment();
                    closePhotoModal();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error deleting photo: ' + error.message, 'error');
            }
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        
        h1 {
            margin-top: 0;
        }
        
        h2 {
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }
        
        input, select, button {
            padding: 10px;
            font-size: 16px;
            margin: 5px 0;
        }
        
        button {
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background: #555;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background: #333;
            color: white;
        }
        
        .status-in {
            background: #d4edda;
        }
        
        .status-out {
            background: #fff3cd;
        }
        
        #scanner-container {
            width: 100%;
            max-width: 500px;
            margin-top: 10px;
        }
        
        .qr-code {
            margin: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            display: inline-block;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        .message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            flex: 1;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Warehouse Equipment Tracker</h1>

    <!-- STATS -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-label">Total Equipment</div>
            <div class="stat-number" id="stat-total">0</div>
        </div>
        <div class="stat-card status-in">
            <div class="stat-label">In Warehouse</div>
            <div class="stat-number" id="stat-in">0</div>
        </div>
        <div class="stat-card status-out">
            <div class="stat-label">Out at Events</div>
            <div class="stat-number" id="stat-out">0</div>
        </div>
    </div>

    <!-- SCAN SECTION -->
    <div class="section">
        <h2>Scan Equipment</h2>
        
        <!-- Manual/Barcode Scanner Input -->
        <div>
            <input type="text" id="manual-code" placeholder="Scan or type equipment code here" autofocus style="width: 400px;">
            <button onclick="processManualScan()">Submit</button>
        </div>
        
        <!-- Camera Scanner -->
        <div style="margin-top: 20px;">
            <button onclick="startCameraScanner()">Use Camera Scanner</button>
            <button onclick="stopCameraScanner()" class="hidden" id="stop-camera-btn">Stop Camera</button>
        </div>
        <div id="scanner-container" class="hidden"></div>
        
        <div id="scan-result" class="hidden"></div>
    </div>

    <!-- ADD NEW EQUIPMENT -->
    <div class="section">
        <h2>Add New Equipment</h2>
        <input type="text" id="new-equipment-name" placeholder="Equipment name (e.g., Projector-01)" style="width: 400px;">
        <button onclick="addEquipment()">Add Equipment</button>
    </div>

    <!-- BULK IMPORT -->
    <div class="section">
        <h2>Bulk Add Equipment</h2>
        <p>Enter multiple equipment names, one per line:</p>
        <textarea id="bulk-equipment" rows="5" style="width: 100%; padding: 10px; font-size: 16px;" placeholder="Projector-01&#10;Speaker-A&#10;Laptop-03&#10;..."></textarea>
        <button onclick="bulkAddEquipment()">Add All</button>
    </div>

    <!-- BACKUP/RESTORE -->
    <div class="section">
        <h2>Backup & Restore</h2>
        <button onclick="exportData()">Download Backup (JSON)</button>
        <button onclick="exportCSV()">Download as CSV</button>
        <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData()">
        <button onclick="document.getElementById('import-file').click()">Restore from Backup</button>
    </div>

    <!-- GENERATE QR CODES -->
    <div class="section">
        <h2>Generate QR Codes</h2>
        <button onclick="generateAllQRCodes()">Generate QR Codes for All Equipment</button>
        <button onclick="window.print()" id="print-btn" class="hidden">Print QR Codes</button>
        <div id="qr-codes-container"></div>
    </div>

    <!-- EQUIPMENT LIST -->
    <div class="section">
        <h2>All Equipment</h2>
        <div style="margin-bottom: 10px;">
            <input type="text" id="search-box" placeholder="Search equipment..." style="width: 300px;" onkeyup="filterEquipment()">
            <select id="filter-status" onchange="filterEquipment()" style="width: 150px;">
                <option value="ALL">All Status</option>
                <option value="IN">In Warehouse</option>
                <option value="OUT">Out at Event</option>
            </select>
        </div>
        <table id="equipment-table">
            <thead>
                <tr>
                    <th>Equipment ID</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Location/Event</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="equipment-list">
            </tbody>
        </table>
    </div>

    <script>
        let equipment = [];
        let html5QrCode = null;

        // Initialize - load equipment from server
        loadEquipment();

        // Load all equipment from server
        async function loadEquipment() {
            try {
                const response = await fetch('/api/equipment');
                equipment = await response.json();
                displayEquipment();
                updateStats();
            } catch (error) {
                showMessage('Error loading equipment: ' + error.message, 'error');
            }
        }

        // Update statistics
        function updateStats() {
            const total = equipment.length;
            const inWarehouse = equipment.filter(eq => eq.status === 'IN').length;
            const out = equipment.filter(eq => eq.status === 'OUT').length;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-in').textContent = inWarehouse;
            document.getElementById('stat-out').textContent = out;
        }

        // Add new equipment
        async function addEquipment() {
            const name = document.getElementById('new-equipment-name').value.trim();
            if (!name) {
                alert('Please enter equipment name');
                return;
            }

            try {
                const response = await fetch('/api/equipment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                
                const data = await response.json();
                if (response.ok) {
                    showMessage('Equipment added: ' + name, 'success');
                    document.getElementById('new-equipment-name').value = '';
                    loadEquipment();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error adding equipment: ' + error.message, 'error');
            }
        }

        // Bulk add equipment
        async function bulkAddEquipment() {
            const text = document.getElementById('bulk-equipment').value.trim();
            if (!text) {
                alert('Please enter equipment names');
                return;
            }

            const names = text.split('\n').filter(name => name.trim());
            let added = 0;
            
            for (const name of names) {
                try {
                    const response = await fetch('/api/equipment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name.trim() })
                    });
                    if (response.ok) added++;
                } catch (error) {
                    console.error('Error adding ' + name, error);
                }
            }

            showMessage(`Added ${added} items successfully`, 'success');
            document.getElementById('bulk-equipment').value = '';
            loadEquipment();
        }

        // Process manual/barcode scanner input
        function processManualScan() {
            const code = document.getElementById('manual-code').value.trim();
            if (!code) return;

            processCode(code);
            document.getElementById('manual-code').value = '';
            document.getElementById('manual-code').focus();
        }

        // Allow Enter key for manual input
        document.getElementById('manual-code').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processManualScan();
            }
        });

        // Start camera scanner
        function startCameraScanner() {
            document.getElementById('scanner-container').classList.remove('hidden');
            document.getElementById('stop-camera-btn').classList.remove('hidden');
            
            html5QrCode = new Html5Qrcode("scanner-container");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    processCode(decodedText);
                    stopCameraScanner();
                },
                (error) => {
                    // Ignore errors during scanning
                }
            ).catch(err => {
                showMessage('Unable to start camera: ' + err, 'error');
            });
        }

        // Stop camera scanner
        function stopCameraScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-container').classList.add('hidden');
                    document.getElementById('stop-camera-btn').classList.add('hidden');
                });
            }
        }

        // Process scanned code
        async function processCode(code) {
            let location = '';
            
            // Check if equipment is being checked out
            const item = equipment.find(eq => eq.id === code);
            if (item && item.status === 'IN') {
                location = prompt('Where is this equipment going?', 'Event Location');
                if (location === null) return; // Cancelled
            }

            try {
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, location: location })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage(data.message, 'success');
                    loadEquipment();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error processing scan: ' + error.message, 'error');
            }
        }

        // Show message
        function showMessage(message, type) {
            const resultDiv = document.getElementById('scan-result');
            resultDiv.textContent = message;
            resultDiv.className = 'message message-' + type;
            resultDiv.classList.remove('hidden');
            
            setTimeout(() => {
                resultDiv.classList.add('hidden');
            }, 5000);
        }

        // Display equipment list
        function displayEquipment() {
            const tbody = document.getElementById('equipment-list');
            tbody.innerHTML = '';

            let filteredEquipment = [...equipment];
            
            // Apply filters
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            
            if (searchTerm) {
                filteredEquipment = filteredEquipment.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) || 
                    item.id.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter !== 'ALL') {
                filteredEquipment = filteredEquipment.filter(item => item.status === statusFilter);
            }

            filteredEquipment.forEach(item => {
                const row = tbody.insertRow();
                row.className = item.status === 'IN' ? 'status-in' : 'status-out';
                
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td><strong>${item.status}</strong></td>
                    <td>${item.location}</td>
                    <td>${item.last_updated}</td>
                    <td>
                        <button onclick="deleteEquipment('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        // Filter equipment
        function filterEquipment() {
            displayEquipment();
        }

        // Delete equipment
        async function deleteEquipment(id) {
            if (!confirm('Delete this equipment?')) return;
            
            try {
                const response = await fetch(`/api/equipment/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('Equipment deleted', 'success');
                    loadEquipment();
                } else {
                    showMessage('Error deleting equipment', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Export data as JSON
        async function exportData() {
            try {
                const response = await fetch('/api/export');
                const data = await response.json();
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'equipment-backup-' + new Date().toISOString().split('T')[0] + '.json';
                link.click();
                
                showMessage('Backup downloaded successfully', 'success');
            } catch (error) {
                showMessage('Error exporting data: ' + error.message, 'error');
            }
        }

        // Export as CSV
        async function exportCSV() {
            try {
                const response = await fetch('/api/export');
                const data = await response.json();
                
                let csv = 'ID,Name,Status,Location,Last Updated\n';
                data.forEach(item => {
                    csv += `"${item.id}","${item.name}","${item.status}","${item.location}","${item.last_updated}"\n`;
                });
                
                const blob = new Blob([csv], {type: 'text/csv'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'equipment-' + new Date().toISOString().split('T')[0] + '.csv';
                link.click();
                
                showMessage('CSV downloaded successfully', 'success');
            } catch (error) {
                showMessage('Error exporting CSV: ' + error.message, 'error');
            }
        }

        // Import data
        async function importData() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    const response = await fetch('/api/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ equipment: data })
                    });
                    
                    const result = await response.json();
                    if (response.ok) {
                        showMessage(result.message, 'success');
                        loadEquipment();
                    } else {
                        showMessage('Error: ' + result.error, 'error');
                    }
                } catch (error) {
                    showMessage('Error importing data: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Generate QR codes
        function generateAllQRCodes() {
            const container = document.getElementById('qr-codes-container');
            container.innerHTML = '<p>Generating codes...</p>';

            setTimeout(() => {
                container.innerHTML = '';
                
                equipment.forEach(item => {
                    const qrDiv = document.createElement('div');
                    qrDiv.className = 'qr-code';
                    qrDiv.innerHTML = `
                        <h3>${item.name}</h3>
                        <div style="margin: 10px 0;">
                            <strong>QR Code:</strong><br>
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(item.id)}" alt="QR Code" style="border: 1px solid #ccc; padding: 10px; background: white;">
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Barcode:</strong><br>
                            <img src="https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(item.id)}&code=Code128&translate-esc=on&eclevel=L" alt="Barcode" style="max-width: 250px;">
                        </div>
                        <p><strong>ID: ${item.id}</strong></p>
                    `;
                    container.appendChild(qrDiv);
                });
                
                document.getElementById('print-btn').classList.remove('hidden');
                showMessage('Codes generated! Both QR codes and barcodes are ready. Print and test which works better with your scanner.', 'success');
            }, 100);
        }
    </script>
</body>
</html>